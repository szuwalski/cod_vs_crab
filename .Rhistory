cod_dat_clean <- cod_dat %>%
select(-hauljoin) %>%
#remove all data with no station ID (HAVE TO DEAL WITH THIS LATER)
filter(!is.na(station)) %>%
group_by(station,year,AreaSwept_km2) %>%
summarise(mean_depth=mean(depth,na.rm = T),
mean_number=mean(number,na.rm=T),
n=n(),
mean_weight=mean(weight,na.rm=T))
# Aggregate by station and year
cod_dat_clean <- cod_dat %>%
select(-hauljoin) %>%
#remove all data with no station ID (HAVE TO DEAL WITH THIS LATER)
filter(!is.na(station)) %>%
group_by(station,Year,AreaSwept_km2) %>%
summarise(mean_depth=mean(depth,na.rm = T),
mean_number=mean(number,na.rm=T),
n=n(),
mean_weight=mean(weight,na.rm=T))
View(cod_dat_clean)
# Aggregate by station and year
cod_dat_clean <- cod_dat %>%
select(-hauljoin) %>%
#remove all data with no station ID (HAVE TO DEAL WITH THIS LATER)
filter(!is.na(station)) %>%
group_by(station,Year,AreaSwept_km2) %>%
summarise(mean_depth=mean(depth,na.rm = T),
mean_number=mean(number,na.rm=T),
mean_weight=mean(weight,na.rm=T))
# Aggregate by station and year
cod_dat_clean <- cod_dat %>%
select(-hauljoin) %>%
#remove all data with no station ID (HAVE TO DEAL WITH THIS LATER)
filter(!is.na(station)) %>%
group_by(station,Year,AreaSwept_km2,midlon,midlat) %>%
summarise(mean_depth=mean(depth,na.rm = T),
mean_number=mean(number,na.rm=T),
mean_weight=mean(weight,na.rm=T)) %>%
ungroup()
View(cod_dat_clean)
rm(test)
test <- cod_dat %>% count(station,Year,AreaSwept_km2,midlon,midlat)
unique(test$n)
test <- cod_dat %>% filter(!is.na(station) %>% count(station,Year,AreaSwept_km2,midlon,midlat)
test <- cod_dat %>% filter(!is.na(station)) %>% count(station,Year,AreaSwept_km2,midlon,midlat)
unique(test$n)
# Aggregate by station and year
cod_dat_clean <- cod_dat %>%
select(-hauljoin) %>%
#remove all data with no station ID (HAVE TO DEAL WITH THIS LATER)
filter(!is.na(station)) %>%
select(station,Year,AreaSwept_km2,midlon,midlat)
#==Load the opilio data
load("longform_opilio.Rdata")
MMB<- opi_dat[opi_dat$units=="kilos" & opi_dat$Sex=="Male" & opi_dat$Maturity=="Mature",] %>%
group_by(Year) %>%
summarise(MMB = mean(value*AreaSwept_km2,na.rm=T),
MMBsd = sd(value*AreaSwept_km2,na.rm=T))
# mature female biomass
MFB<- opi_dat[opi_dat$units=="kilos" & opi_dat$Sex=="Female" & opi_dat$Maturity=="Mature",] %>%
group_by(Year) %>%
summarise(MFB = mean(value*AreaSwept_km2,na.rm=T),
MFBsd = sd(value*AreaSwept_km2,na.rm=T))
# recruits
rec<- opi_dat[opi_dat$units=="kilos" & opi_dat$Sex=="Male" & opi_dat$Size<38,] %>%
group_by(Year) %>%
summarise(rec = mean(value*AreaSwept_km2,na.rm=T),
recsd = sd(value*AreaSwept_km2,na.rm=T))
#==these need lognormal CIs put around them
par(mfrow=c(3,1),mar=c(.1,.1,.1,.1),oma=c(4,4,1,1))
plot(rec$rec~rec$Year,type='l',xaxt='n',las=1)
legend('topright',bty='n',"Recruits")
#==a proxy for exploitable males
plot(MMB$MMB~MMB$Year,type='l',xaxt='n',las=1)
legend('topright',bty='n',"Mature male biomass")
#==a proxy for reproductive potential
plot(MFB$MFB~MFB$Year,type='l',las=1)
legend('topright',bty='n',"Mature female biomass")
mtext(side=2,line=3,"Mean density (kg/km^2",outer=T)
MMB<- opi_dat[opi_dat$units=="kilos" & opi_dat$Sex=="Male" & opi_dat$Maturity=="Mature",] %>%
group_by(Year) %>%
summarise(MMB = mean(value/AreaSwept_km2,na.rm=T),
MMBsd = sd(value/AreaSwept_km2,na.rm=T))
# mature female biomass
MFB<- opi_dat[opi_dat$units=="kilos" & opi_dat$Sex=="Female" & opi_dat$Maturity=="Mature",] %>%
group_by(Year) %>%
summarise(MFB = mean(value/AreaSwept_km2,na.rm=T),
MFBsd = sd(value/AreaSwept_km2,na.rm=T))
# recruits
rec<- opi_dat[opi_dat$units=="kilos" & opi_dat$Sex=="Male" & opi_dat$Size<38,] %>%
group_by(Year) %>%
summarise(rec = mean(value/AreaSwept_km2,na.rm=T),
recsd = sd(value/AreaSwept_km2,na.rm=T))
#==these need lognormal CIs put around them
par(mfrow=c(3,1),mar=c(.1,.1,.1,.1),oma=c(4,4,1,1))
plot(rec$rec~rec$Year,type='l',xaxt='n',las=1)
legend('topright',bty='n',"Recruits")
#==a proxy for exploitable males
plot(MMB$MMB~MMB$Year,type='l',xaxt='n',las=1)
legend('topright',bty='n',"Mature male biomass")
#==a proxy for reproductive potential
plot(MFB$MFB~MFB$Year,type='l',las=1)
legend('topright',bty='n',"Mature female biomass")
mtext(side=2,line=3,"Mean density (kg/km^2",outer=T)
# Aggregate by station and year
cod_dat_clean <- cod_dat %>%
select(-hauljoin) %>%
#remove all data with no station ID (HAVE TO DEAL WITH THIS LATER)
filter(!is.na(station)) %>%
select(station,Year,AreaSwept_km2,midlon,midlat,weight,number)
cod_by_yr <-cod_dat_clean %>%
group_by(Year) %>%
summarise(num=mean(number/AreaSwept_km2,na.rm = T),
weight=mean(weight/AreaSwept_km2,na.rm=T)) %>%
ungroup()
View(cod_by_yr)
cod_by_yr %>%
ggplot(aes(Year,weight))+
geom_line()+
geom_point()
cod_by_yr %>%
ggplot(aes(Year,weight))+
geom_line()+
geom_point()+
labs(x='year',y='weight (kg/km2)')
?geom_ribbon
weight_by_yr_plot <-cod_by_yr %>%
ggplot(aes(Year,weight))+
geom_line()+
geom_point()+
geom_ribbon(aes(ymin=weight-weight_sd,ymax=weight+weight_sd))+
labs(x='year',y='weight (kg/km2)')
weight_by_yr_plot
cod_by_yr <-cod_dat_clean %>%
group_by(Year) %>%
summarise(num=mean(number/AreaSwept_km2,na.rm = T),
num_sd=sd(number/AreaSwept_km2,na.rm = T),
weight=mean(weight/AreaSwept_km2,na.rm=T),
weight_sd=sd(weight/AreaSwept_km2,na.rm=T)) %>%
ungroup()
weight_by_yr_plot <-cod_by_yr %>%
ggplot(aes(Year,weight))+
geom_line()+
geom_point()+
geom_ribbon(aes(ymin=weight-weight_sd,ymax=weight+weight_sd))+
labs(x='year',y='weight (kg/km2)')
weight_by_yr_plot
weight_by_yr_plot <-cod_by_yr %>%
ggplot(aes(Year,weight))+
geom_line()+
geom_point()+
geom_ribbon(aes(ymin=weight-weight_sd,ymax=weight+weight_sd),alpha=0.3)+
labs(x='year',y='weight (kg/km2)')
weight_by_yr_plot
cod_by_yr <-cod_dat_clean %>%
group_by(Year) %>%
summarise(n_obs=n(),
num=mean(number/AreaSwept_km2,na.rm = T),
num_sd=sd(number/AreaSwept_km2,na.rm = T),
weight=mean(weight/AreaSwept_km2,na.rm=T),
weight_sd=sd(weight/AreaSwept_km2,na.rm=T)) %>%
ungroup()
test <- cod_dat_clean %>% filter(Year==1982)
View(test)
sd(test$weight)
sd(test$weight/test$AreaSwept_km2)
mean(test$weight/test$AreaSwept_km2)
cod_by_yr <-cod_dat_clean %>%
group_by(Year) %>%
summarise(n_obs=n(),
num=mean(number/AreaSwept_km2,na.rm = T),
num_sd=sd(number/AreaSwept_km2,na.rm = T),
weight=mean(weight/AreaSwept_km2,na.rm=T),
weight_sd=sd(weight/AreaSwept_km2,na.rm=T)) %>%
ungroup()
cod_by_yr <-cod_dat_clean %>%
group_by(Year) %>%
summarise(n_obs=n(),
num=mean(number/AreaSwept_km2),
num_sd=sd(number/AreaSwept_km2),
weight=mean(weight/AreaSwept_km2),
weight_sd=sd(weight/AreaSwept_km2)) %>%
ungroup()
cod_by_yr <-cod_dat_clean %>%
group_by(Year) %>%
summarise(n_obs=n(),
num=mean(number/AreaSwept_km2,na.rm = T),
num_sd=sd(number/AreaSwept_km2,na.rm = T),
weight=mean(weight/AreaSwept_km2,na.rm=T),
weight_sd=sd(weight/AreaSwept_km2,na.rm=T)) %>%
ungroup()
# Aggregate by station and year
cod_dat_clean <- cod_dat %>%
select(-hauljoin) %>%
#remove all data with no station ID (HAVE TO DEAL WITH THIS LATER)
filter(!is.na(station)) %>%
select(station,Year,AreaSwept_km2,midlon,midlat,weight,number) %>%
#density in numbers and weight
mutate(dens_weight=weight/AreaSwept_km2,dens_num=number/AreaSwept_km2)
35/0.01303
cod_by_yr <-cod_dat_clean %>%
group_by(Year) %>%
summarise(n_obs=n(),
num=mean(dens_num,na.rm = T),
num_sd=sd(dens_num,na.rm = T),
weight=mean(dens_weight,na.rm=T),
weight_sd=sd(dens_weight,na.rm=T)) %>%
ungroup()
?upper()
?upper
pmax(c(1,3,4,5,6),4)
weight_by_yr_plot <-cod_by_yr %>%
ggplot(aes(Year,weight))+
geom_line()+
geom_point()+
geom_ribbon(aes(ymin=pmax(0,weight-weight_sd),ymax=weight+weight_sd),alpha=0.3)+
labs(x='year',y='weight (kg/km2)')
weight_by_yr_plot
weight_by_yr_plot <-cod_by_yr %>%
ggplot(aes(Year,dens_weight))+
geom_line()+
geom_point()+
labs(x='year',y='weight (kg/km2)')
weight_by_yr_plot
library(gridExtra)
cod_by_yr <-cod_dat_clean %>%
group_by(Year) %>%
summarise(n_obs=n(),
num=mean(dens_num,na.rm = T),
num_sd=sd(dens_num,na.rm = T),
weight=mean(dens_weight,na.rm=T),
weight_sd=sd(dens_weight,na.rm=T)) %>%
ungroup()
weight_by_yr_plot <-cod_by_yr %>%
ggplot(aes(Year,weight))+
geom_line()+
geom_point()+
labs(x='year',y='weight (kg/km2)')
num_by_yr_plot <-cod_by_yr %>%
ggplot(aes(Year,num))+
geom_line(col='blue')+
geom_point(col='blue')+
labs(x='year',y='density (number/km2)')
library(gridExtra)
grid.arrange(weight_by_yr_plot,num_by_yr_plot)
# compare visually to assessment data
assessment_abundance <- read_csv(here("data","assessment_tot_abun.csv"))
# compare visually to assessment data
assessment_abundance <- read_csv(here("data","assessment_tot_abun.csv"),col_types = 'dddddd')
# compare visually to assessment data
assessment_abundance <- read_csv(here("data","assessment_tot_abun.csv"),col_types = 'dddddd') %>%
ggplot(aes(Year,Estimate))+
geom_point(col='darkgreen')+geom_line(col='darkgreen')+
labs(x='year',y='Abundance (1000s fish)')
assessment_abundance
# compare visually to assessment data
assessment_abundance <- read_csv(here("data","assessment_tot_abun.csv"),col_types = 'dddddd') %>%
ggplot(aes(Year,Estimate))+
geom_point(col='darkgreen')+geom_line(col='darkgreen')+
labs(x='year',y='Abundance (1000s fish)')+
theme(panel.border = element_rect(fill=NA,col="darkgreen",linewidth=2))
# compare visually to assessment data
assessment_abundance <- read_csv(here("data","assessment_tot_abun.csv"),col_types = 'dddddd') %>%
ggplot(aes(Year,Estimate))+
geom_point(col='darkgreen')+geom_line(col='darkgreen')+
labs(x='year',y='Abundance (1000s fish)')+
theme(panel.border = element_rect(fill=NA,col="darkgreen"))
?element_rect
# compare visually to assessment data
assessment_abundance <- read_csv(here("data","assessment_tot_abun.csv"),col_types = 'dddddd') %>%
ggplot(aes(Year,Estimate))+
geom_point(col='darkgreen')+geom_line(col='darkgreen')+
labs(x='year',y='Abundance (1000s fish)')+
theme(panel.border = element_rect(fill=NA,color="darkgreen",size=2))
grid.arrange(weight_by_yr_plot,num_by_yr_plot,assessment_abundance)
sizecomp <- read_csv('data/assessment_size_comp.csv')
View(sizecomp)
sizecomp <- read_csv('data/assessment_size_comp.csv')
sizecomp %>% gather(cm,prop,-Year,-N)
sizecomp %>% gather(cm,prop,-Year,-N)->sizecomp
View(sizecomp)
sizecomp <- sizecomp %>% select(-N)
sizecomp %>% group_by(Year) %>% summarise(tot=sum(prop))
test <- sizecomp %>% filter(Year==1982)
View(test)
sum(test$prop)
sizecomp <- read_csv('data/assessment_size_comp.csv')
#size composition (from assessment)
sizecomp <- read_csv('data/assessment_size_comp.csv')%>% gather(cm,prop,-Year,-N)
save(cod_dat_clean,"data/cod_dat_clean.Rdata")
save(cod_dat_clean,file="data/cod_dat_clean.Rdata")
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(rEDM)
# figure theme
plot_theme <-   theme_minimal()+
theme(text=element_text(family="sans",size=12,color="black"),
legend.text = element_text(size=14),
axis.title=element_text(family="sans",size=14,color="black"),
axis.text=element_text(family="sans",size=8,color="black"),
panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(rEDM)
# figure theme
plot_theme <-   theme_minimal()+
theme(text=element_text(family="sans",size=12,color="black"),
legend.text = element_text(size=14),
axis.title=element_text(family="sans",size=14,color="black"),
axis.text=element_text(family="sans",size=8,color="black"),
panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
load('data/cod_dat_clean.Rdata')
load('data/longform_opilio.Rdata')
names(opi_dat)
unique(opi_dat$units)
View(opi_dat)
length(unique(opi_dat$Lat))
opi_recruits <- opi_dat %>%
filter(Size<38,units=='number')
View(opi_recruits)
View(cod_dat_clean)
# normalized cod time series
codnorm <- cod_dat_clean %>%
select(station,Year,dens_weight) %>%
arrange(station,Year)
View(codnorm)
# normalized cod time series
codnorm <- cod_dat_clean %>%
select(station,Year,dens_weight) %>%
arrange(station,Year) %>%
group_by(station) %>%
complete(Year=full_seq(Year))
# normalized cod time series
codnorm <- cod_dat_clean %>%
select(station,Year,dens_weight) %>%
arrange(station,Year) %>%
group_by(station) %>%
complete(Year=full_seq(Year,1))
# normalized cod time series
codnorm <- cod_dat_clean %>%
select(station,Year,dens_weight) %>%
arrange(station,Year) %>%
group_by(station) %>%
complete(Year=full_seq(Year,1)) %>%
ungroup() %>%
mutate(normdens=(dens_weight-mean(dens_weight,na.rm=T))/sd(dens_weight,na.rm=T))
codsegs <- codnorm %>%
group_by(station) %>%
summarise(first=first(),last=last())
codsegs <- codnorm %>%
ungroup() %>%
mutate(n=row_number()) %>%
group_by(station) %>%
summarise(first=first(),last=last())
codsegs <- codnorm %>%
ungroup() %>%
mutate(n=row_number()) %>%
group_by(station) %>%
summarise(first=first(n),last=last(n))
View(codsegs)
?simplex
head(as.matrix(codsegs))
codsegs <- codnorm %>%
ungroup() %>%
mutate(n=row_number()) %>%
group_by(station) %>%
summarise(first=first(n),last=last(n)) %>%
select(-station) %>% ungroup()
codsimp <- simplex(codnorm$normdens,lib=as.matrix(codsegs))
View(codsimp)
codsimp <- simplex(codnorm$normdens,lib=as.matrix(codsegs),E=1:15)
# Mature males
sprintf("plots/Mature Males, %d.png", 1982:1987) %>%
purrr::map(image_read) %>%
image_join() %>%
image_animate(fps=2,loop=1)%>%
image_write("plots/gifs/mature_males.gif")
library(tidyverse)
library(gstat)
library(sf)
library(raster)
library(rasterVis)
library(rgdal)
library(viridis)
## Animate gifs
library(magick)
# Mature males
sprintf("plots/Mature Males, %d.png", 1982:1987) %>%
purrr::map(image_read) %>%
image_join() %>%
image_animate(fps=2,loop=1)%>%
image_write("plots/gifs/mature_males.gif")
# figure theme
plot_theme <-   theme_minimal()+
theme(text=element_text(family="sans",size=12,color="black"),
legend.text = element_text(size=14),
axis.title=element_text(family="sans",size=14,color="black"),
# axis.text=element_blank(),
axis.text=element_text(family="sans",size=8,color="black"),
panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
# import data
load('data/longform_opilio.Rdata')
# for now, let's start with one year of mature male crabs, collapsing all size classes
dat <- opi_dat %>% filter(Year==1982,Sex=='Male',Maturity=='Mature') %>%
group_by(Year,Lat,Lon) %>%
summarise(density_weight=sum(value/AreaSwept_km2,na.rm=T)) %>%
ungroup()
yr <- "1982"
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(dat,coords=c('Lon','Lat'),crs=4326) %>% st_transform(3571)
dat.sp <- dat.sf %>% as_Spatial()
dat.ch <- st_convex_hull(st_union(dat.sf))
#
# # so we know what we're dealing with
# dat.sf %>%
#   ggplot()+
#   geom_sf(aes(size=log(density_weight)),alpha=0.3)
#raster
r <- raster(dat.sp)
res(r) <- 1000 #1 km
#interpolate using inverse distance weighting
idm<-gstat(formula=density_weight~1,locations=dat.sp)
dat.idw <- interpolate(r,idm) %>% mask(as_Spatial(dat.ch))%>%
as.data.frame(xy=TRUE)
# state outline
ak <- read_sf('data/spatial/cb_2017_02_anrc_500k.shp') %>%
st_union() %>%
st_transform(3571)
bbox <- st_bbox(dat.sf)
## function to create a map like the above
interpolate_data <- function(df,yr,sex,maturity,scalelimits,save.plot=TRUE) {
#subset data
dat <- df %>%
filter(Year==yr,Sex==sex,Maturity==maturity) %>%
group_by(Year,Lat,Lon) %>%
summarise(density_weight=sum(value/AreaSwept_km2/1e6,na.rm=T)) %>%
ungroup()
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(dat,coords=c('Lon','Lat'),crs=4326) %>% st_transform(3571)
dat.sp <- dat.sf %>% as_Spatial()
dat.ch <- st_convex_hull(st_union(dat.sf))
#interpolate using inverse distance weighting
idm<-gstat(formula=density_weight~1,locations=dat.sp)
dat.idw <- suppressMessages(interpolate(r,idm)) %>%
mask(as_Spatial(dat.ch)) %>%
as.data.frame(xy=TRUE)
plot.title <- paste0(maturity," ",sex,"s, ",yr)
out<-ggplot()+
geom_raster(data=dat.idw,aes(x,y,fill=var1.pred),na.rm=T,alpha=0.8)+
geom_sf(data=ak,fill='gray80')+
# projectRaster(crs="+proj=longlat +datum=WGS84 +no_defs") %>%
# gplot(dat.idw)+
xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
labs(x='',y='',fill='Density\n(1000s MT/km2)',title=plot.title)+
scale_fill_viridis(na.value=NA,option="C",limits=scalelimits)
if(save.plot) {
suppressMessages(ggsave(plot=out,filename=paste0("plots/",plot.title,".png")))
print(paste(plot.title,"saved!"))
}
out
}
interpolate
?interpolate
## function to create a map like the above
interpolate_data <- function(df,yr,sex,maturity,scalelimits,save.plot=TRUE) {
#subset data
dat <- df %>%
filter(Year==yr,Sex==sex,Maturity==maturity) %>%
group_by(Year,Lat,Lon) %>%
summarise(density_weight=sum(value/AreaSwept_km2/1e6,na.rm=T)) %>%
ungroup()
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(dat,coords=c('Lon','Lat'),crs=4326) %>% st_transform(3571)
dat.sp <- dat.sf %>% as_Spatial()
dat.ch <- st_convex_hull(st_union(dat.sf))
#interpolate using inverse distance weighting
idm<-gstat(formula=density_weight~1,locations=dat.sp)
dat.idw <- interpolate(r,idm) %>%
mask(as_Spatial(dat.ch)) %>%
as.data.frame(xy=TRUE)
plot.title <- paste0(maturity," ",sex,"s, ",yr)
out<-ggplot()+
geom_raster(data=dat.idw,aes(x,y,fill=var1.pred),na.rm=T,alpha=0.8)+
geom_sf(data=ak,fill='gray80')+
# projectRaster(crs="+proj=longlat +datum=WGS84 +no_defs") %>%
# gplot(dat.idw)+
xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
labs(x='',y='',fill='Density\n(1000s MT/km2)',title=plot.title)+
scale_fill_viridis(na.value=NA,option="C",limits=scalelimits)
if(save.plot) {
suppressMessages(ggsave(plot=out,filename=paste0("plots/",plot.title,".png")))
print(paste(plot.title,"saved!"))
}
out
}
# For mature females
walk(1982:2017, ~{
interpolate_data(df=opi_dat,yr=.x,sex="Female",maturity="Mature",scalelimits=c(0,25),save.plot=TRUE)
})
# For immature males
walk(1982:2017, ~{
interpolate_data(df=opi_dat,yr=.x,sex="Male",maturity="Immature",scalelimits=c(0,10),save.plot=TRUE)
})
# For immature females
walk(1982:2017, ~{
interpolate_data(df=opi_dat,yr=.x,sex="Female",maturity="Immature",scalelimits=c(0,10),save.plot=TRUE)
})
