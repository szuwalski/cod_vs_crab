unique(opi_dat_long$size)
2*22*2*2
sum(is.na(opi_dat_long$size))
t6 <- filter(opi_dat_long,is.na(size))
View(t6)
max(data$WIDTH,na.rm=T)
opi.dat <- data %>%
# remove obs with no sex
filter(!is.na(SEX)) %>%
# select variables of interest
select(AKFIN_SURVEY_YEAR,GIS_STATION,MID_LATITUDE,MID_LONGITUDE, AREA_SWEPT_VARIABLE,
GEAR_TEMPERATURE,GEAR_DEPTH,BOTTOM_DEPTH,SEX,WIDTH,CLUTCH_SIZE,SHELL_CONDITION,
CALCULATED_WEIGHT,SAMPLING_FACTOR) %>%
#rename some variables
rename(year=AKFIN_SURVEY_YEAR,station=GIS_STATION,lat=MID_LATITUDE,lon=MID_LONGITUDE,
area_km2=AREA_SWEPT_VARIABLE,temp=GEAR_TEMPERATURE,depth_gear=GEAR_DEPTH,depth=BOTTOM_DEPTH) %>%
# sex as character
mutate(sex=ifelse(SEX==2,"Female","Male")) %>%
# add size class bins by matching to the "key" above
# by rounding down and up to the nearest multiple of 5
mutate(dn=5*floor((WIDTH+0.1)/5),up=5*ceiling((WIDTH+0.1)/5)) %>%
left_join(sizesdf,by=c("dn","up")) %>%
filter(!is.na(size)) %>%
select(-dn,-up) %>%
# join the male maturity dataset by size bin for use in calculating probability of male maturity below
left_join(mat_df,by=c('size'='Size')) %>%
# add probability of maturity for both males and females
mutate(prob_mature=case_when(
SEX==2 & CLUTCH_SIZE>0 ~ 1,
SEX==2 & CLUTCH_SIZE==0 ~ 0,
# probs of male maturity come from 'mat_df' dataframe
SEX==1 & SHELL_CONDITION<=2 ~ New,
SEX==1 & SHELL_CONDITION >2 ~ Old
)
) %>%
mutate(prob_immature=1-prob_mature) %>%
# summarize values of interest
group_by(station,lat,lon,year,sex,size) %>%
summarise(
# number and weight of mature and immature crabs
num_mature=sum(SAMPLING_FACTOR*prob_mature,na.rm=T),
num_immature=sum(SAMPLING_FACTOR*prob_immature,na.rm=T),
weight_mature=sum(CALCULATED_WEIGHT*SAMPLING_FACTOR*prob_mature,na.rm=T),
weight_immature=sum(CALCULATED_WEIGHT*SAMPLING_FACTOR*prob_immature,na.rm=T),
#other useful descriptives
area_km2 = first(area_km2),
depth_gear=first(depth_gear),
depth=first(depth),
temp=first(temp)
) %>%
ungroup()
## convert to long form
opi_dat_long <- opi.dat %>%
gather(category,value,num_mature:weight_immature) %>%
#rename some stuff and add units
mutate(maturity=ifelse(grepl('immature',category),"Immature","Mature"),
units=ifelse(grepl('weight',category),"kilos","numbers")) %>%
#turn implicit missing values into explicit missing values
#e.g., for every station/year that is in the data (i.e., was surveyed), but
#did not collect any immature females, put in a zero for that observation
complete(sex,size,maturity,units,nesting(station,year,area_km2,lon,lat,depth,depth_gear,temp),fill=list(value=0)) %>%
ungroup() %>%
#select final variables of interest
select(station,year,area_km2,lon,lat,depth,depth_gear,temp,sex,size,maturity,value,units) %>%
arrange(station,year)
t6 <- opi_dat_long %>% count(station,year,size)
View(t6)
t6 <- opi_dat_long %>% count(station,year)
t5 <- opi_dat %>% count(Lat,Lon,Year)
View(t5)
t6 <- opi_dat_long %>% count(lat,lon,year)
View(t6)
t6 <- opi_dat_long %>% count(lat,lon,year) %>% arrange(lat,lon,year)
t5 <- opi_dat %>% count(Lat,Lon,Year) %>% arrange(Lat,Lon,Year)
min(opi_dat$Lon)
min(opi_dat_long$Lon)
min(opi_dat_long$lon)
min(opi_dat_long$lat)
min(opi_dat$Lat)
stations<-unique(data$GIS_STATION)
length(unique(opi_dat$Lat))
length(unique(opi_dat_long$lat))
length(unique(opi_dat_long$lon))
length(unique(opi_dat$Lon))
length(unique(opi_dat_long$station))
length(unique(data$GIS_STATION))
1982:2017
length(1982:2017)
36*length(unique(data$GIS_STATION))
36*length(unique(data$GIS_STATION))*22*8
data %>% group_by(station) %>% summarise(yrs=n_distinct(Year))->t7
data %>% group_by(GIS_STATION) %>% summarise(yrs=n_distinct(Year))->t7
data %>% group_by(GIS_STATION) %>% summarise(yrs=n_distinct(AKFIN_SURVEY_YEAR))->t7
View(t7)
opi_dat %>% group_by(Lat,Lon) %>% summarise(yrs=n_distinct(Year))->t8
View(t8)
opi_dat_long %>% group_by(lat,lon) %>% summarise(yrs=n_distinct(year))->t9
View(t9)
opi_dat_long %>% group_by(station) %>% summarise(yrs=n_distinct(year))->t9
test4<-data %>% filter(GIS_STATION=="F-08")
View(test4)
test3 <- opi_dat_long %>% filter(station=="F-08")
View(test3)
length(unique(test3$lat))
length(unique(test3$lon))
length(unique(test3$year))
test3 <- opi_dat_long %>% filter(station=="F-14")
test4<-data %>% filter(GIS_STATION=="F-14")
View(opi_dat_long)
## SAVE
save(opi_dat_long,file="longform_opilio2.Rdata")
# Produce snow crab data, take 2
# see if we can't make this a bit faster (edit- we did)
library(tidyverse)
t<-proc.time()
data<-read.csv("E:/cod and crab/opilio.csv",header=T,skip=5)
mat_df<-read.csv("data/maturity.csv")
# haul join key (for comparing to other species, e.g. cod, collected in the same survey)
haul_join_key <- data %>% select(HAULJOIN,GIS_STATION,MID_LATITUDE,MID_LONGITUDE,AREA_SWEPT_VARIABLE) %>%
distinct() %>%
rename(midlat=MID_LATITUDE,midlon=MID_LONGITUDE,station=GIS_STATION,AreaSwept_km2=AREA_SWEPT_VARIABLE)
save(haul_join_key,file="data/haul_join_key.Rdata")
# data before 1982 unreliable
use_yr<-seq(1982,2017)
data <- data %>% filter(AKFIN_SURVEY_YEAR>1981)
binsize=5
sizes		 <-seq(27.5,132.5,binsize)
# size bin matching key
sizesdf <- tibble(dn=seq(25,130,5),up=seq(30,135,5),size=sizes)
#=====================PROCESS RAW DATA====================#
opi.dat <- data %>%
# remove obs with no sex
filter(!is.na(SEX)) %>%
# select variables of interest
select(AKFIN_SURVEY_YEAR,GIS_STATION,MID_LATITUDE,MID_LONGITUDE, AREA_SWEPT_VARIABLE,
GEAR_TEMPERATURE,GEAR_DEPTH,BOTTOM_DEPTH,SEX,WIDTH,CLUTCH_SIZE,SHELL_CONDITION,
CALCULATED_WEIGHT,SAMPLING_FACTOR) %>%
#rename some variables
rename(year=AKFIN_SURVEY_YEAR,station=GIS_STATION,lat=MID_LATITUDE,lon=MID_LONGITUDE,
area_km2=AREA_SWEPT_VARIABLE,temp=GEAR_TEMPERATURE,depth_gear=GEAR_DEPTH,depth=BOTTOM_DEPTH) %>%
# sex as character
mutate(sex=ifelse(SEX==2,"Female","Male")) %>%
# add size class bins by matching to the "key" above
# by rounding down and up to the nearest multiple of 5
mutate(dn=5*floor((WIDTH+0.1)/5),up=5*ceiling((WIDTH+0.1)/5)) %>%
left_join(sizesdf,by=c("dn","up")) %>%
filter(!is.na(size)) %>%
select(-dn,-up) %>%
# join the male maturity dataset by size bin for use in calculating probability of male maturity below
left_join(mat_df,by=c('size'='Size')) %>%
# add probability of maturity for both males and females
mutate(prob_mature=case_when(
SEX==2 & CLUTCH_SIZE>0 ~ 1,
SEX==2 & CLUTCH_SIZE==0 ~ 0,
# probs of male maturity come from 'mat_df' dataframe
SEX==1 & SHELL_CONDITION<=2 ~ New,
SEX==1 & SHELL_CONDITION >2 ~ Old
)
) %>%
mutate(prob_immature=1-prob_mature) %>%
# summarize values of interest
group_by(station,lat,lon,year,sex,size) %>%
summarise(
# number and weight of mature and immature crabs
num_mature=sum(SAMPLING_FACTOR*prob_mature,na.rm=T),
num_immature=sum(SAMPLING_FACTOR*prob_immature,na.rm=T),
weight_mature=sum(CALCULATED_WEIGHT*SAMPLING_FACTOR*prob_mature,na.rm=T),
weight_immature=sum(CALCULATED_WEIGHT*SAMPLING_FACTOR*prob_immature,na.rm=T),
#other useful descriptives
area_km2 = first(area_km2),
depth_gear=first(depth_gear),
depth=first(depth),
temp=first(temp)
) %>%
ungroup()
## convert to long form
opi_dat_long <- opi.dat %>%
gather(category,value,num_mature:weight_immature) %>%
#rename some stuff and add units
mutate(maturity=ifelse(grepl('immature',category),"Immature","Mature"),
units=ifelse(grepl('weight',category),"kilos","numbers")) %>%
#turn implicit missing values into explicit missing values
#e.g., for every station/year that is in the data (i.e., was surveyed), but
#did not collect any immature females, put in a zero for that observation
complete(sex,size,maturity,units,nesting(station,year,area_km2,lon,lat,depth,depth_gear,temp),fill=list(value=0)) %>%
ungroup() %>%
#select final variables of interest
select(station,year,area_km2,lon,lat,depth,depth_gear,temp,sex,size,maturity,value,units) %>%
arrange(station,year)
## NOTE: We arrive at a different total number of observations than in the previous interation:
## this seems to be because of the way we're counting NAs; the previous analysis counted year/station combinations
## that are present in the raw data, but without any sample info (sex, weight, etc.), as valid observations
## THIS new analysis does not do that (i.e., it throws out station/year combinations for which there is no useful data,
## and does not assume that those are zeros)
## SAVE
save(opi_dat_long,file="longform_opilio2.Rdata")
proc.time()-t
## SAVE
save(opi_dat_long,file="data/longform_opilio2.Rdata")
# Interpolation, snow crab data
library(tidyverse)
library(gstat)
library(sf)
library(raster)
library(rasterVis)
library(rgdal)
library(viridis)
# figure theme
plot_theme <-   theme_minimal()+
theme(text=element_text(family="sans",size=12,color="black"),
legend.text = element_text(size=14),
axis.title=element_text(family="sans",size=14,color="black"),
# axis.text=element_blank(),
axis.text=element_text(family="sans",size=8,color="black"),
panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
# import data
load('data/longform_opilio2.Rdata')
# for now, let's start with one year of mature male crabs, collapsing all size classes
dat <- opi_dat_long %>% filter(Year==1982,sex=='Male',maturity=='Mature') %>%
group_by(year,lat,lon) %>%
summarise(density_weight=sum(value/AreaSwept_km2,na.rm=T)) %>%
ungroup()
# for now, let's start with one year of mature male crabs, collapsing all size classes
dat <- opi_dat_long %>% filter(year==1982,sex=='Male',maturity=='Mature') %>%
group_by(year,lat,lon) %>%
summarise(density_weight=sum(value/area_km2,na.rm=T)) %>%
ungroup()
yr <- "1982"
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(dat,coords=c('Lon','Lat'),crs=4326) %>% st_transform(3571)
dat.sp <- dat.sf %>% as_Spatial()
dat.ch <- st_convex_hull(st_union(dat.sf))
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(dat,coords=c('lon','lat'),crs=4326) %>% st_transform(3571)
dat.sp <- dat.sf %>% as_Spatial()
dat.ch <- st_convex_hull(st_union(dat.sf))
#raster
r <- raster(dat.sp)
res(r) <- 10000 #1 km
#interpolate using inverse distance weighting
idm<-gstat(formula=density_weight~1,locations=dat.sp)
dat.idw <- interpolate(r,idm) %>% mask(as_Spatial(dat.ch))%>%
as.data.frame(xy=TRUE)
# state outline
ak <- read_sf('data/spatial/cb_2017_02_anrc_500k.shp') %>%
st_union() %>%
st_transform(3571)
bbox <- st_bbox(dat.sf)
bbox <- bbox*c(0.9,1.1,1.1,0.9) #expand by 10%
ggplot()+
geom_raster(data=dat.idw,aes(x,y,fill=var1.pred/1000),na.rm=T,alpha=0.8,interpolate=TRUE)+
geom_sf(data=ak,fill='gray80')+
# projectRaster(crs="+proj=longlat +datum=WGS84 +no_defs") %>%
# gplot(dat.idw)+
xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
labs(x='',y='',fill='Density\n(MT/km2)',title=yr)+
scale_fill_viridis(na.value=NA,option="C")
## function to create a map like the above
interpolate_data <- function(df,yr,sex,maturity) {
#subset data
dat <- df %>%
filter(Year==yr,sex==sex,maturity==maturity) %>%
group_by(year,lat,lon) %>%
summarise(density_weight=sum(value/area_km2/1e6,na.rm=T)) %>%
ungroup()
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(dat,coords=c('lon','lat'),crs=4326) %>% st_transform(3571)
dat.sp <- dat.sf %>% as_Spatial()
dat.ch <- st_convex_hull(st_union(dat.sf))
#interpolate using inverse distance weighting
idm<-gstat(formula=density_weight~1,locations=dat.sp)
dat.idw <- interpolate(r,idm) %>%
mask(as_Spatial(dat.ch)) %>%
as.data.frame(xy=TRUE) %>%
mutate(year=yr)
# plot.title <- paste0(maturity," ",sex,"s, ",yr)
#
# out<-ggplot()+
#   geom_raster(data=dat.idw,aes(x,y,fill=var1.pred),na.rm=T,alpha=0.8)+
#   geom_sf(data=ak,fill='gray80')+
#   # projectRaster(crs="+proj=longlat +datum=WGS84 +no_defs") %>%
#   # gplot(dat.idw)+
#   xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
#   labs(x='',y='',fill='Density\n(1000s MT/km2)',title=plot.title)+
#   scale_fill_viridis(na.value=NA,option="C",limits=scalelimits)
#
# if(save.plot) {
#   suppressMessages(ggsave(plot=out,filename=paste0("plots/",plot.title,".png")))
#   print(paste(plot.title,"saved!"))
#   }
#
dat.idw
}
# appropriate scale limits for different categories
#mature males c(0,10)
#immature males c(0,10)
#mature females c(0,25)
#immature females c(0,10)
### Calculate and save plots (takes a long time)
# For mature males
purrr::map(1982:2017, ~{
interpolate_data(df=opi_dat_long,yr=.x,sex="Male",maturity="Mature")
}) %>% bind_rows() -> mm.interpolated
# For mature females
purrr::map(1982:2017, ~{
interpolate_data(df=opi_dat_long,yr=.x,sex="Female",maturity="Mature")
}) %>% bind_rows() -> mf.interpolated
# For immature males
purrr::map(1982:2017, ~{
interpolate_data(df=opi_dat_long,yr=.x,sex="Male",maturity="Immature")
}) %>% bind_rows() -> im.interpolated
# For immature females
purrr::map(1982:2017, ~{
interpolate_data(df=opi_dat_long,yr=.x,sex="Female",maturity="Immature")
}) %>% bind_rows() -> if.interpolated
## function to create a map like the above
interpolate_data <- function(df,yr,sex,maturity) {
#subset data
dat <- df %>%
filter(year==yr,sex==sex,maturity==maturity) %>%
group_by(year,lat,lon) %>%
summarise(density_weight=sum(value/area_km2/1e6,na.rm=T)) %>%
ungroup()
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(dat,coords=c('lon','lat'),crs=4326) %>% st_transform(3571)
dat.sp <- dat.sf %>% as_Spatial()
dat.ch <- st_convex_hull(st_union(dat.sf))
#interpolate using inverse distance weighting
idm<-gstat(formula=density_weight~1,locations=dat.sp)
dat.idw <- interpolate(r,idm) %>%
mask(as_Spatial(dat.ch)) %>%
as.data.frame(xy=TRUE) %>%
mutate(year=yr)
# plot.title <- paste0(maturity," ",sex,"s, ",yr)
#
# out<-ggplot()+
#   geom_raster(data=dat.idw,aes(x,y,fill=var1.pred),na.rm=T,alpha=0.8)+
#   geom_sf(data=ak,fill='gray80')+
#   # projectRaster(crs="+proj=longlat +datum=WGS84 +no_defs") %>%
#   # gplot(dat.idw)+
#   xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
#   labs(x='',y='',fill='Density\n(1000s MT/km2)',title=plot.title)+
#   scale_fill_viridis(na.value=NA,option="C",limits=scalelimits)
#
# if(save.plot) {
#   suppressMessages(ggsave(plot=out,filename=paste0("plots/",plot.title,".png")))
#   print(paste(plot.title,"saved!"))
#   }
#
dat.idw
}
### Calculate and save plots (takes a long time)
# For mature males
purrr::map(1982:2017, ~{
interpolate_data(df=opi_dat_long,yr=.x,sex="Male",maturity="Mature")
}) %>% bind_rows() -> mm.interpolated
# For mature females
purrr::map(1982:2017, ~{
interpolate_data(df=opi_dat_long,yr=.x,sex="Female",maturity="Mature")
}) %>% bind_rows() -> mf.interpolated
# For immature males
purrr::map(1982:2017, ~{
interpolate_data(df=opi_dat_long,yr=.x,sex="Male",maturity="Immature")
}) %>% bind_rows() -> im.interpolated
# For immature females
purrr::map(1982:2017, ~{
interpolate_data(df=opi_dat_long,yr=.x,sex="Female",maturity="Immature")
}) %>% bind_rows() -> if.interpolated
## With gganimate
library(gganimate)
mm.gif<-mm.interpolated %>%
ggplot()+
geom_raster(aes(x,y,fill=var1.pred,frame=year),na.rm=T,alpha=0.8,interpolate = TRUE)+
geom_sf(data=ak,fill='gray80')+
xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
labs(x='',y='',fill='Density\n(1000s MT/km2)',title='Mature Males, {frame_time}')+
scale_fill_viridis(na.value=NA,option="C",limits=c(0,10))+
theme(plot.title = element_text(size=16))+
transition_time(year)
animate(mm.gif,fps=4,width=800,height=600)
anim_save(filename="plots/gifs/mature_males.gif")
mf.gif<-mf.interpolated %>%
ggplot()+
geom_raster(aes(x,y,fill=var1.pred,frame=year),na.rm=T,alpha=0.8,interpolate = TRUE)+
geom_sf(data=ak,fill='gray80')+
xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
labs(x='',y='',fill='Density\n(1000s MT/km2)',title='Mature Females, {frame_time}')+
scale_fill_viridis(na.value=NA,option="C",limits=c(0,10))+
theme(plot.title = element_text(size=16))+
transition_time(year)
animate(mf.gif,fps=4,width=800,height=600)
anim_save(filename="plots/gifs/mature_females.gif")
im.gif<-im.interpolated %>%
ggplot()+
geom_raster(aes(x,y,fill=var1.pred,frame=year),na.rm=T,alpha=0.8,interpolate = TRUE)+
geom_sf(data=ak,fill='gray80')+
xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
labs(x='',y='',fill='Density\n(1000s MT/km2)',title='Immature Males, {frame_time}')+
scale_fill_viridis(na.value=NA,option="C",limits=c(0,10))+
theme(plot.title = element_text(size=16))+
transition_time(year)
animate(im.gif,fps=4,width=800,height=600)
anim_save(filename="plots/gifs/immature_males.gif")
if.gif<-if.interpolated %>%
ggplot()+
geom_raster(aes(x,y,fill=var1.pred,frame=year),na.rm=T,alpha=0.8,interpolate = TRUE)+
geom_sf(data=ak,fill='gray80')+
xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
labs(x='',y='',fill='Density\n(1000s MT/km2)',title='Immature Females, {frame_time}')+
scale_fill_viridis(na.value=NA,option="C",limits=c(0,10))+
theme(plot.title = element_text(size=16))+
transition_time(year)
animate(if.gif,fps=4,width=800,height=600)
anim_save(filename="plots/gifs/immature_females.gif")
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(opi_dat_long,coords=c('lon','lat'),crs=4326) %>% st_transform(3571)
load("data/longform_opilio.Rdata")
mf <- opi_dat %>% filter(Maturity=="Mature",Sex=="Female")
quantile(mf,0.9)
quantile(mf$value,0.9)
quantile(mf$value,0.9,na.rm=T)
quantile(mf$value,0.95,na.rm=T)
quantile(mf$value,0.99,na.rm=T)
quantile(mf$value,0.999,na.rm=T)
mf2 <- opi_dat_long %>% filter(maturity=="Mature",sex=="Female")
quantile(mf2$value,0.999,na.rm=T)
mf2 <- mf2 %>% filter(year==1996)
mf <- mf %>% filter(year==1996)
mf <- mf %>% filter(Year==1996)
mf %>% ggplot(value,..density..)+geom_density(fill="purple",alpha=0.7)
mf %>% ggplot(aes(value,..density..))+geom_density(fill="purple",alpha=0.7)
mf2 %>% ggplot(aes(value,..density..))+geom_density(fill="purple",alpha=0.7)
max(mf2$value)
max(mf$value)
quantile(mf$value,0.5)
immf<-opi_dat_long %>% filter(maturity=="Immature",sex=="Female",year==1996)
immf2<-opi_dat %>% filter(Maturity=="Immature",Sex=="Female",Year==1996)
immf2 %>% ggplot(aes(value,..density..))+geom_density(fill="purple",alpha=0.7)
immf %>% ggplot(aes(value,..density..))+geom_density(fill="purple",alpha=0.7)
# for now, let's start with one year of mature male crabs, collapsing all size classes
dat <- opi_dat_long %>% filter(year==1982,sex=='Female',maturity=='Immature') %>%
group_by(year,lat,lon) %>%
summarise(density_weight=sum(value/area_km2/1e6,na.rm=T)) %>%
ungroup()
yr <- "1982"
yr <- "1996"
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(opi_dat_long,coords=c('lon','lat'),crs=4326) %>% st_transform(3571)
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(opi_dat_long,coords=c('lon','lat'),crs=4326) %>% st_transform(3571)
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(dat,coords=c('lon','lat'),crs=4326) %>% st_transform(3571)
dat.sp <- dat.sf %>% as_Spatial()
dat.ch <- st_convex_hull(st_union(dat.sf))
#raster
r <- raster(dat.sp)
res(r) <- 10000 #1 km
#interpolate using inverse distance weighting
idm<-gstat(formula=density_weight~1,locations=dat.sp)
dat.idw <- interpolate(r,idm) %>% mask(as_Spatial(dat.ch))%>%
as.data.frame(xy=TRUE)
# state outline
ak <- read_sf('data/spatial/cb_2017_02_anrc_500k.shp') %>%
st_union() %>%
st_transform(3571)
bbox <- st_bbox(dat.sf)
bbox <- bbox*c(0.9,1.1,1.1,0.9) #expand by 10%
ggplot()+
geom_raster(data=dat.idw,aes(x,y,fill=var1.pred),na.rm=T,alpha=0.8,interpolate=TRUE)+
geom_sf(data=ak,fill='gray80')+
# projectRaster(crs="+proj=longlat +datum=WGS84 +no_defs") %>%
# gplot(dat.idw)+
xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
labs(x='',y='',fill='Density\n(MT/km2)',title=yr)+
scale_fill_viridis(na.value=NA,option="C")
# for now, let's start with one year of mature male crabs, collapsing all size classes
dat <- opi_dat_long %>% filter(year==1996,sex=='Female',maturity=='Immature') %>%
group_by(year,lat,lon) %>%
summarise(density_weight=sum(value/area_km2/1e6,na.rm=T)) %>%
ungroup()
yr <- "1996"
# convert to simple features (spatial points) object
dat.sf <- st_as_sf(dat,coords=c('lon','lat'),crs=4326) %>% st_transform(3571)
dat.sp <- dat.sf %>% as_Spatial()
dat.ch <- st_convex_hull(st_union(dat.sf))
#
# # so we know what we're dealing with
# dat.sf %>%
#   ggplot()+
#   geom_sf(aes(size=log(density_weight)),alpha=0.3)
#raster
r <- raster(dat.sp)
res(r) <- 10000 #1 km
#interpolate using inverse distance weighting
idm<-gstat(formula=density_weight~1,locations=dat.sp)
dat.idw <- interpolate(r,idm) %>% mask(as_Spatial(dat.ch))%>%
as.data.frame(xy=TRUE)
# state outline
ak <- read_sf('data/spatial/cb_2017_02_anrc_500k.shp') %>%
st_union() %>%
st_transform(3571)
bbox <- st_bbox(dat.sf)
bbox <- bbox*c(0.9,1.1,1.1,0.9) #expand by 10%
ggplot()+
geom_raster(data=dat.idw,aes(x,y,fill=var1.pred),na.rm=T,alpha=0.8,interpolate=TRUE)+
geom_sf(data=ak,fill='gray80')+
# projectRaster(crs="+proj=longlat +datum=WGS84 +no_defs") %>%
# gplot(dat.idw)+
xlim(bbox[1],bbox[3])+ylim(bbox[2],bbox[4])+
labs(x='',y='',fill='Density\n(MT/km2)',title=yr)+
scale_fill_viridis(na.value=NA,option="C")
